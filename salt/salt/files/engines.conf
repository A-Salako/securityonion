engines_dirs:
  - /etc/salt/engines

engines:
  - checkmine:
      interval: 60
  - valueWatch:
      watched:
        - value: GLOBALMERGED.pipeline
          files:
            - /opt/so/saltstack/local/pillar/global/soc_global.sls
            - /opt/so/saltstack/local/pillar/global/adv_global.sls
          map: global/map.jinja
          targets:
            - so-manager
            - so-managersearch
          ttype: compound
          actions:
            from:
              '*':
                to:
                  KAFKA:
                  - cmd.run:
                      cmd: /usr/sbin/so-yaml.py replace /opt/so/saltstack/local/pillar/kafka/soc_kafka.sls kafka.enabled True
              KAFKA:
                to:
                  '*':
                  - cmd.run:
                      cmd: /usr/sbin/so-yaml.py replace /opt/so/saltstack/local/pillar/kafka/soc_kafka.sls kafka.enabled False

        - value: FIREWALL_MERGED
          files:
            - /opt/so/saltstack/local/pillar/firewall/soc_firewall.sls
            - /opt/so/saltstack/local/pillar/firewall/adv_firewall.sls
            - /opt/so/saltstack/local/pillar/minions/*.sls
          map: firewall/map.jinja
          targets:
            - so-*
          ttype: compound
          actions:
            from:
              '*':
                to:
                  '*':
                  - cmd.run:
                      cmd: date
      interval: 10


  - pillarWatch:
      fpa:
        # these files will be checked in reversed order to replicate the same hierarchy as the pillar top file
        - files:
            - /opt/so/saltstack/local/pillar/global/soc_global.sls
            - /opt/so/saltstack/local/pillar/global/adv_global.sls
          pillar: global.pipeline
          actions:
            from:
              '*':
                to:
                  KAFKA:
                  - cmd.run:
                      cmd: /usr/sbin/so-yaml.py replace /opt/so/saltstack/local/pillar/kafka/soc_kafka.sls kafka.enabled True
#                  - cmd.run:
#                      cmd: salt-call saltutil.kill_all_jobs
#                  - cmd.run:
#                      cmd: salt-call state.highstate &
              KAFKA:
                to:
                  '*':
                  - cmd.run:
                      cmd: /usr/sbin/so-yaml.py replace /opt/so/saltstack/local/pillar/kafka/soc_kafka.sls kafka.enabled False
#                  - cmd.run:
#                      cmd: salt-call saltutil.kill_all_jobs
#                  - cmd.run:
#                      cmd: salt-call state.highstate &
        - files:
            - /opt/so/saltstack/local/pillar/idstools/soc_idstools.sls
            - /opt/so/saltstack/local/pillar/idstools/adv_idstools.sls
          pillar: idstools.config.ruleset
          actions:
            from:
              '*':
                to:
                  '*':
                  - cmd.run:
                      cmd: /usr/sbin/so-rule-update
      interval: 10
  - valWatch:
      fpa:
        - value: GLOBALMERGED.pipeline
          map: global/map.jinja
          targets:
            - so-manager
            - so-managersearch
            - so-standalone
        
          actions:
            from:
              '*':
                to:
                  KAFKA:
                  - cmd.run:
                      cmd: /usr/sbin/so-yaml.py replace /opt/so/saltstack/local/pillar/kafka/soc_kafka.sls kafka.enabled True
#                  - cmd.run:
#                      cmd: salt-call saltutil.kill_all_jobs
#                  - cmd.run:
#                      cmd: salt-call state.highstate &
              KAFKA:
                to:
                  '*':
                  - cmd.run:
                      cmd: /usr/sbin/so-yaml.py replace /opt/so/saltstack/local/pillar/kafka/soc_kafka.sls kafka.enabled False
#                  - cmd.run:
#                      cmd: salt-call saltutil.kill_all_jobs
#                  - cmd.run:
#                      cmd: salt-call state.highstate &
#        - files:
#            - /opt/so/saltstack/local/pillar/idstools/soc_idstools.sls
#            - /opt/so/saltstack/local/pillar/idstools/adv_idstools.sls
#          pillar: idstools.config.ruleset
#          actions:
#            from:
#              '*':
#                to:
#                  '*':
#                  - cmd.run:
#                      cmd: /usr/sbin/so-rule-update
      interval: 10
